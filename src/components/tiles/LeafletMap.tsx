import { LatLngTuple, GeoJSON as LeafletGeoJSON } from "leaflet";
import { LayerGroup, LayersControl, MapContainer, TileLayer, useMap, GeoJSON, GeoJSONProps } from 'react-leaflet';
import Tile from "../Tile";
import ReactResizeDetector from 'react-resize-detector';
import 'leaflet/dist/leaflet.css';
import { useEffect, ReactElement, useRef } from "react";
import { useMapStore } from "../../service/stores";
import "../../assets/styles/leafletmap.scss"

/* fixes https://github.com/PaulLeCam/react-leaflet/issues/453#issuecomment-410450387 */
import L from 'leaflet';
import { useZones } from "../../utils/zones";
/* @ts-ignore */
delete L.Icon.Default.prototype._getIconUrl;
L.Icon.Default.mergeOptions({
  iconRetinaUrl: require('leaflet/dist/images/marker-icon-2x.png'),
  iconUrl: require('leaflet/dist/images/marker-icon.png'),
  shadowUrl: require('leaflet/dist/images/marker-shadow.png')
});

/**
 * from https://github.com/PaulLeCam/react-leaflet/issues/332#issuecomment-849679887
 * GeoJsonWithUpdates is a wrapper around react-leaflet's GeoJSON component to support data changes
 * See https://github.com/PaulLeCam/react-leaflet/issues/332
 *
 * It accepts the same props like react-leaflet's GeoJSON component.
 * However, updates are only support
 */
const GeoJsonWithUpdates = (props: GeoJSONProps): ReactElement => {
  const geoJsonLayerRef = useRef<LeafletGeoJSON | null>(null);

  useEffect(() => {
    const layer = geoJsonLayerRef.current;
    if (layer) {
      layer.clearLayers().addData(props.data);
      // clearLayers() seems to remove the `pathOptions`, `style` and `interactive` prop as well
      // Resetting it here
      if (props.pathOptions) {
        layer.setStyle(props.pathOptions);
      } else if (props.style) {
        layer.setStyle(props.style);
      }
    }
  }, [props.data, props.pathOptions, props.style]);

  return <GeoJSON {...props} ref={geoJsonLayerRef} />;
}

const LeafletMapContainer = ({ center, zoom }: { center: LatLngTuple, zoom: number }) => {
  const updateCenterStore = useMapStore(state => state.setCenter)

  const { data: zonesData, isSuccess: isZonesReady } = useZones()

  const m = useMap()
  useEffect(() => {
    // window.addEventListener("resize", () => {
    //   m.invalidateSize()
    // })
    const t = setInterval(() => { /* invalidate container dimension fromt time to time */
      m.invalidateSize()
    }, 300)
    return () => clearInterval(t)
  }, [m])

  m.on("moveend", (e) => {
    const moved = m.getCenter()
    updateCenterStore([moved.lat, moved.lng])
  })



  const d = {
    "type": "Feature",
    "geometry": {
      "type": "MultiPolygon",
      "coordinates": [
        [
          [
            [
              12.95313896654873,
              52.28889955389399
            ],
            [
              12.94708619876332,
              52.2868815685269
            ],
            [
              12.94398311957077,
              52.28562071109631
            ],
            [
              12.94133548041033,
              52.2840461142312
            ],
            [
              12.9348491240118,
              52.2821209467622
            ],
            [
              12.92368813218161,
              52.27814724334103
            ],
            [
              12.91975263841565,
              52.27685536796147
            ],
            [
              12.91442155438309,
              52.2755914952664
            ],
            [
              12.90823505864361,
              52.27379254239197
            ],
            [
              12.90995410324729,
              52.27960712513544
            ],
            [
              12.90277575882533,
              52.28723812270124
            ],
            [
              12.9042384140167,
              52.28742475914131
            ],
            [
              12.90394394361565,
              52.28823154177165
            ],
            [
              12.90248317992946,
              52.2880808578144
            ],
            [
              12.90215859069297,
              52.28914919807805
            ],
            [
              12.90369795465709,
              52.28939729502289
            ],
            [
              12.90335153591344,
              52.29033109699425
            ],
            [
              12.90198421771708,
              52.29000755892533
            ],
            [
              12.90000525391455,
              52.29004719858959
            ],
            [
              12.89913671810525,
              52.29027155281267
            ],
            [
              12.8979920618174,
              52.29137428618641
            ],
            [
              12.89732303883317,
              52.29645385474464
            ],
            [
              12.88516675986349,
              52.29887396018747
            ],
            [
              12.88038100459763,
              52.29996790349055
            ],
            [
              12.87148659313865,
              52.29997319206539
            ],
            [
              12.86919357090007,
              52.30018949529478
            ],
            [
              12.85907340341862,
              52.29921025930392
            ],
            [
              12.85679466414925,
              52.30023399767708
            ],
            [
              12.85575938608512,
              52.30123048027849
            ],
            [
              12.85382646033593,
              52.30356960445609
            ],
            [
              12.85225615219596,
              52.30329447707328
            ],
            [
              12.85226496406616,
              52.29901350219164
            ],
            [
              12.84216814603757,
              52.29975875885487
            ],
            [
              12.83647077161439,
              52.30006678566753
            ],
            [
              12.82330673497563,
              52.30095247111634
            ],
            [
              12.82250768025148,
              52.30111192351515
            ],
            [
              12.81681132282333,
              52.29765883597018
            ],
            [
              12.81044998711261,
              52.29524410255951
            ],
            [
              12.80484941184678,
              52.29347134427872
            ],
            [
              12.79924030311518,
              52.29184234890833
            ],
            [
              12.79569163232117,
              52.29102854010975
            ],
            [
              12.78818694698996,
              52.28946237919969
            ],
            [
              12.78611660584932,
              52.28722267295416
            ],
            [
              12.78440347982922,
              52.28482695402609
            ],
            [
              12.78415292323051,
              52.28371276772087
            ],
            [
              12.78207598509519,
              52.27918601202991
            ],
            [
              12.78211824088153,
              52.271905671198
            ],
            [
              12.78122789167009,
              52.26967307325414
            ],
            [
              12.79095574232135,
              52.26799898935851
            ],
            [
              12.7935289582861,
              52.26823545397137
            ],
            [
              12.79895385649996,
              52.26752561107859
            ],
            [
              12.79914108848487,
              52.26659519396749
            ],
            [
              12.80886240337804,
              52.26540042911427
            ],
            [
              12.8128452906541,
              52.26407162752047
            ],
            [
              12.81289217620283,
              52.26649915781485
            ],
            [
              12.81560949776274,
              52.26651809267897
            ],
            [
              12.81559969478112,
              52.2633041717025
            ],
            [
              12.81900197327525,
              52.26230983642343
            ],
            [
              12.8290099657984,
              52.26143536628885
            ],
            [
              12.82947789708787,
              52.2632833227786
            ],
            [
              12.83017632403956,
              52.26495038481665
            ],
            [
              12.83064812333277,
              52.26732204414992
            ],
            [
              12.83109704306829,
              52.27307741910265
            ],
            [
              12.8287126281497,
              52.27320476828379
            ],
            [
              12.83011311719484,
              52.27646195030275
            ],
            [
              12.83598045733873,
              52.27616774951612
            ],
            [
              12.83850672865632,
              52.26171677199084
            ],
            [
              12.84588139063306,
              52.26176304958784
            ],
            [
              12.84819206605744,
              52.25653563536877
            ],
            [
              12.8500654712229,
              52.25214502407129
            ],
            [
              12.85040864177473,
              52.25155365423346
            ],
            [
              12.84720733469649,
              52.25032964509002
            ],
            [
              12.84413227711817,
              52.24842819068024
            ],
            [
              12.84832192062624,
              52.2455475514498
            ],
            [
              12.85175280576486,
              52.24499429652038
            ],
            [
              12.85296608178598,
              52.2446465125944
            ],
            [
              12.85836020472806,
              52.24211076760654
            ],
            [
              12.85998639945298,
              52.24097189382029
            ],
            [
              12.86117616850936,
              52.23933767821107
            ],
            [
              12.86164544155873,
              52.23822158732883
            ],
            [
              12.86321253658458,
              52.23343936160945
            ],
            [
              12.8711147975428,
              52.23683759970274
            ],
            [
              12.87345675060433,
              52.23148194378575
            ],
            [
              12.88044037439402,
              52.23273808495193
            ],
            [
              12.881252877724,
              52.23147109676097
            ],
            [
              12.88367569200291,
              52.23183682133461
            ],
            [
              12.88474115519401,
              52.23036679598912
            ],
            [
              12.88619999232563,
              52.2305177004489
            ],
            [
              12.88686913076341,
              52.22903755524371
            ],
            [
              12.87637059613182,
              52.22725770853868
            ],
            [
              12.87796549274797,
              52.22554326189116
            ],
            [
              12.86808475387068,
              52.22434435052549
            ],
            [
              12.87341271487484,
              52.22005438299192
            ],
            [
              12.87420869862837,
              52.21930969211795
            ],
            [
              12.87500600231935,
              52.21775507637689
            ],
            [
              12.87590120225531,
              52.213885811752
            ],
            [
              12.8767116010456,
              52.21258288495066
            ],
            [
              12.88051289252202,
              52.20864601562906
            ],
            [
              12.88178176527962,
              52.20733471735276
            ],
            [
              12.88280613710146,
              52.20592849168893
            ],
            [
              12.88302524589789,
              52.2045292989116
            ],
            [
              12.88236458937205,
              52.20311163191944
            ],
            [
              12.88042052746799,
              52.20068463218517
            ],
            [
              12.87893482682547,
              52.19827780038738
            ],
            [
              12.88210413427702,
              52.19777342114214
            ],
            [
              12.88918050788966,
              52.19546158493996
            ],
            [
              12.88861823273089,
              52.19479789280336
            ],
            [
              12.88718342229078,
              52.19397163663902
            ],
            [
              12.88489331097408,
              52.19358537238111
            ],
            [
              12.88567706490638,
              52.19206691593284
            ],
            [
              12.88764801543278,
              52.19084872000716
            ],
            [
              12.89071829274658,
              52.19030467832094
            ],
            [
              12.89192840517064,
              52.19120906762137
            ],
            [
              12.90106429028331,
              52.18871732523062
            ],
            [
              12.90237222004854,
              52.18743119219277
            ],
            [
              12.90328058081933,
              52.18736801683996
            ],
            [
              12.90266240881838,
              52.18521372409961
            ],
            [
              12.90145789341593,
              52.17785679188147
            ],
            [
              12.90197122028425,
              52.17658454244455
            ],
            [
              12.9052837574625,
              52.17293223171785
            ],
            [
              12.90278588253126,
              52.17039016969641
            ],
            [
              12.90338704596826,
              52.16825173086265
            ],
            [
              12.9032343996902,
              52.16061893553416
            ],
            [
              12.90880981999622,
              52.1606257466239
            ],
            [
              12.9087802501674,
              52.15630925028018
            ],
            [
              12.91042267455166,
              52.15602162410647
            ],
            [
              12.90953191299809,
              52.15201946823238
            ],
            [
              12.91248781594489,
              52.15203182071378
            ],
            [
              12.9153561110574,
              52.15067798445083
            ],
            [
              12.9149923560716,
              52.14989340226389
            ],
            [
              12.91641263196237,
              52.14745288390724
            ],
            [
              12.9171585033946,
              52.14268607946976
            ],
            [
              12.91765435309572,
              52.14112825956585
            ],
            [
              12.92022997348012,
              52.14142708050913
            ],
            [
              12.92176375955539,
              52.14193595671374
            ],
            [
              12.93003372903874,
              52.14340590505457
            ],
            [
              12.93692041715176,
              52.14314179553955
            ],
            [
              12.94216759635122,
              52.14355848878301
            ],
            [
              12.94574994789548,
              52.14396142484
            ],
            [
              12.94839308330771,
              52.1447949426173
            ],
            [
              12.94947141006844,
              52.14552879019129
            ],
            [
              12.95128765599907,
              52.14530255148267
            ],
            [
              12.95198518936651,
              52.14683613880725
            ],
            [
              12.94939686190563,
              52.14739319687839
            ],
            [
              12.95163291168116,
              52.1588345526946
            ],
            [
              12.95168318058648,
              52.15988245622111
            ],
            [
              12.95421092501271,
              52.16062252010322
            ],
            [
              12.95350987307779,
              52.16145585650625
            ],
            [
              12.94851709661552,
              52.16437503992847
            ],
            [
              12.94795231403202,
              52.16529554064153
            ],
            [
              12.94941948441046,
              52.16617441599185
            ],
            [
              12.95090422052776,
              52.16521704952855
            ],
            [
              12.95277003089125,
              52.16588972472053
            ],
            [
              12.95452765518233,
              52.16591664015771
            ],
            [
              12.95516613384342,
              52.16716343642668
            ],
            [
              12.95413756963658,
              52.1684354670095
            ],
            [
              12.95577557965066,
              52.16976072718009
            ],
            [
              12.95912035587479,
              52.16898889149092
            ],
            [
              12.97126857918031,
              52.16532580932552
            ],
            [
              12.97419222400762,
              52.16462242667567
            ],
            [
              12.98621055944267,
              52.16455986293894
            ],
            [
              12.99338468169964,
              52.1656793501868
            ],
            [
              12.99722233918523,
              52.16600421174069
            ],
            [
              12.9991600890292,
              52.16584671763937
            ],
            [
              13.00380564062605,
              52.1656954970335
            ],
            [
              13.00594933579371,
              52.16582156390872
            ],
            [
              13.01224154976263,
              52.1668594241774
            ],
            [
              13.01650006164021,
              52.16790379331256
            ],
            [
              13.02492443045937,
              52.17092906146454
            ],
            [
              13.02664100360706,
              52.16944479478691
            ],
            [
              13.04805577047801,
              52.17933988705976
            ],
            [
              13.05490265243121,
              52.1808137198202
            ],
            [
              13.05703297450566,
              52.18172214912941
            ],
            [
              13.05983698690597,
              52.18159915240846
            ],
            [
              13.05882919343398,
              52.18474362465912
            ],
            [
              13.05921108205791,
              52.18502344255605
            ],
            [
              13.06507784853178,
              52.18726466426122
            ],
            [
              13.06817878417482,
              52.18926804609588
            ],
            [
              13.07082975584719,
              52.19082203878871
            ],
            [
              13.07677104273424,
              52.19409855673578
            ],
            [
              13.08215601737721,
              52.19631987616995
            ],
            [
              13.08253344250133,
              52.19661739066484
            ],
            [
              13.08372719430388,
              52.19767190903785
            ],
            [
              13.08427790032349,
              52.19933256877475
            ],
            [
              13.09000900342481,
              52.21028961352222
            ],
            [
              13.09012624355327,
              52.21118613933585
            ],
            [
              13.09173990386779,
              52.21122319337043
            ],
            [
              13.09250730277984,
              52.21157555687612
            ],
            [
              13.09408913275404,
              52.21309822608905
            ],
            [
              13.09454775079772,
              52.21419524951873
            ],
            [
              13.09244572037254,
              52.21509578444825
            ],
            [
              13.09488298379905,
              52.21696889577671
            ],
            [
              13.09775610619641,
              52.2175005393374
            ],
            [
              13.09877797065235,
              52.21729744943067
            ],
            [
              13.09985810068404,
              52.21761688402241
            ],
            [
              13.10006189017304,
              52.21901293605824
            ],
            [
              13.09827349578135,
              52.21959945205429
            ],
            [
              13.10031294544346,
              52.22269831445116
            ],
            [
              13.10271525731867,
              52.22536064066247
            ],
            [
              13.10150770559845,
              52.22539279849359
            ],
            [
              13.09924744768609,
              52.2253339106908
            ],
            [
              13.09338947725487,
              52.2270394049621
            ],
            [
              13.08498356434357,
              52.22786415963541
            ],
            [
              13.08279699106872,
              52.22545605173792
            ],
            [
              13.07913419389682,
              52.22649799734448
            ],
            [
              13.07911823069755,
              52.2272161484446
            ],
            [
              13.07297746638198,
              52.22696733102604
            ],
            [
              13.0732052166906,
              52.23380726966559
            ],
            [
              13.07107368920096,
              52.24255704149941
            ],
            [
              13.0635812437413,
              52.2417652505667
            ],
            [
              13.05585974059981,
              52.24172941203965
            ],
            [
              13.05271459463131,
              52.24158952269892
            ],
            [
              13.04308973987744,
              52.24014745394179
            ],
            [
              13.04423625196876,
              52.24202196861621
            ],
            [
              13.04427151250146,
              52.24862676411098
            ],
            [
              13.04509242252586,
              52.24992322707523
            ],
            [
              13.04430058203425,
              52.25226188673638
            ],
            [
              13.04420318609205,
              52.25495475929946
            ],
            [
              13.03887479702306,
              52.25488761244754
            ],
            [
              13.03613003822347,
              52.25506481944657
            ],
            [
              13.03308324816406,
              52.25539121513159
            ],
            [
              13.02910129389039,
              52.25603955352758
            ],
            [
              13.0276710060784,
              52.256434174288
            ],
            [
              13.02360979070159,
              52.25666267788494
            ],
            [
              13.02330975693134,
              52.25762858536835
            ],
            [
              13.00524934978999,
              52.25865649646936
            ],
            [
              13.00007573828053,
              52.25912174874564
            ],
            [
              12.99921899436375,
              52.2576927249871
            ],
            [
              12.99635177444018,
              52.25808548517162
            ],
            [
              12.99231440540138,
              52.25933044688736
            ],
            [
              12.98846744180964,
              52.26137222945671
            ],
            [
              12.98685923345381,
              52.26172959444971
            ],
            [
              12.9835077249795,
              52.26212309297572
            ],
            [
              12.98236298554328,
              52.26264176825948
            ],
            [
              12.98045401264061,
              52.26393217759555
            ],
            [
              12.97841736803433,
              52.2658371277769
            ],
            [
              12.97257542891375,
              52.26548989712769
            ],
            [
              12.97002141236716,
              52.26679344146884
            ],
            [
              12.96595432922085,
              52.26698521353085
            ],
            [
              12.95877685344659,
              52.26769966866238
            ],
            [
              12.95211410873431,
              52.2835482339411
            ],
            [
              12.95188110318781,
              52.28438989145517
            ],
            [
              12.95209517278898,
              52.28616727743747
            ],
            [
              12.95313896654873,
              52.28889955389399
            ]
          ]
        ]
      ]
    }
  } as any

  return <LayersControl position="topright">
    
    <LayersControl.Overlay checked name="<b>Standard</b>">
      <TileLayer
        // attribution='&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a>'
        url="https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png"
      />
      {/*  <Marker position={center}>
        <Popup>
          A pretty CSS3 popup. <br /> Easily customizable.
        </Popup>
      </Marker> */}
    </LayersControl.Overlay>
    <LayersControl.Overlay name="<b>Topografie</b>">
      <LayerGroup>
        <TileLayer
          // attribution='&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors'
          url="https://tile.opentopomap.org/{z}/{x}/{y}.png"
        />
        {/* <Circle
          center={center}
          pathOptions={{ fillColor: 'blue' }}
          radius={200}
        />
        <Circle
          center={center}
          pathOptions={{ fillColor: 'red' }}
          radius={100}
          stroke={false}
        />
        <LayerGroup>
          <Circle
            center={[51.51, -0.08]}
            pathOptions={{ color: 'green', fillColor: 'green' }}
            radius={100}
          />
        </LayerGroup> */}
      </LayerGroup>
    </LayersControl.Overlay>

    <LayersControl.Overlay name="<b>Satellit</b>">
      <TileLayer
        url="https://server.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}.jpg"
      />
    </LayersControl.Overlay>
    
    <LayersControl.Overlay name="Standard Weich">
      <TileLayer
        url="https://basemaps.cartocdn.com/rastertiles/voyager/{z}/{x}/{y}.png"
      />
    </LayersControl.Overlay>
    <LayersControl.Overlay name="Standard Dunkel">
      <TileLayer
        url="https://basemaps.cartocdn.com/dark_all/{z}/{x}/{y}.png"
      />
    </LayersControl.Overlay>
    <LayersControl.Overlay name="Standard Grau">
      <TileLayer
        url="https://cartodb-basemaps-b.global.ssl.fastly.net/light_nolabels/{z}/{x}/{y}.png"
      />
    </LayersControl.Overlay>
    {/* <LayersControl.Overlay name="Topografie (ESRI)">
      <TileLayer
        url="https://services.arcgisonline.com/ArcGIS/rest/services/World_Topo_Map/MapServer/tile/{z}/{y}/{x}.jpg"
      />
    </LayersControl.Overlay> */}
    <LayersControl.Overlay name="- Feuerwehr">
      <TileLayer
        url="https://openfiremap.de/hytiles/{z}/{x}/{y}.png"
      />
    </LayersControl.Overlay>
    <LayersControl.Overlay name="- Schienenverkehr">
      <TileLayer
        url="http://c.tiles.openrailwaymap.org/standard/{z}/{x}/{y}.png"
      />
    </LayersControl.Overlay>
    <LayersControl.Overlay name="- Wanderwege">
      <TileLayer
        url="http://tile.waymarkedtrails.org/hiking/{z}/{x}/{y}.png"
      />
    </LayersControl.Overlay>
    <LayersControl.Overlay name="- Labels">
      <TileLayer
        url="https://basemaps.cartocdn.com/rastertiles/voyager_only_labels/{z}/{x}/{y}.jpg"
      />
    </LayersControl.Overlay>
    <LayersControl.Overlay checked name={`<b class="text-underline">Alle Zonen</b>`}>
      <LayerGroup>
        {isZonesReady && zonesData.map((z: any) => <GeoJsonWithUpdates data={z.geo_json} style={{ fillColor: "#2196F3", color: "#2196F3" }} />)}
      </LayerGroup>
    </LayersControl.Overlay>
  </LayersControl>
}

const LeafletMap = () => {
  const center = useMapStore(state => state.center)
  // const center = [50.06, 8.64] as LatLngTuple

  return <ReactResizeDetector handleWidth handleHeight >
    {({ height, width, targetRef }) =>
      /* @ts-ignore */
      <Tile classes="p-0" style={{ zIndex: 111 }}>
        {/* @ts-ignore */}
        <MapContainer attributionControl={false} ref={targetRef} center={center} zoom={8} scrollWheelZoom={true} style={{ width: width ?? "100%", height: height ?? "100%" }} /* style={{ width: "100%", height: "100%" }} */>
          <LeafletMapContainer center={center} zoom={8}></LeafletMapContainer>
        </MapContainer>
      </Tile>
    }
  </ReactResizeDetector>
}
export default LeafletMap